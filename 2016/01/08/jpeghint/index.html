<!DOCTYPE html>
<html lang="ja-JP">
<head>
<meta charset="utf-8">
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="awmlabs">
<meta name="generator" content="Hugo 0.16-DEV" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type="text/css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="awm-Tech">
<title>JPEG の size hinting について - awm-Tech</title>
</head>
<body>

<header>
  <div class="container">
    <a class="path" href="https://blog.awm.jp/">[awm-Tech]</a>
    <span class="caret"># _</span>
  </div>
</header>

<div class="container">


<main role="main" class="article">
  
<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2016-01-08">January 08, 2016</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="https://blog.awm.jp/categories/imagemagick">ImageMagick</a>

    </span>


    <br>
    <span class="key">tags:</span>
    <span class="val">

        <a href="https://blog.awm.jp/tags/imagemagick">ImageMagick</a>

        <a href="https://blog.awm.jp/tags/jpeg">JPEG</a>

        <a href="https://blog.awm.jp/tags/resize">Resize</a>

    </span>

  </div>
  <h1 class="headline" itemprop="headline">JPEG の size hinting について</h1>
  <section class="body" itemprop="articleBody">
    

<p>何度もしつこいですけど、以下の記事の -define jpeg:size への勝手な補足。</p>

<ul>
<li>もうサムネイルで泣かないための ImageMagick ノウハウ集

<ul>
<li><a href="http://blog.cybozu.io/entry/2016/01/06/080000">http://blog.cybozu.io/entry/2016/01/06/080000</a></li>
</ul></li>
</ul>

<pre><code>いつでもつければ良いというものではないので注意しましょう。弊社では、
このオプションはサービスの安定運用のためには無用と判断し、
現在このオプションは利用していません。
</code></pre>

<p>注意する点ではありますが、この結論では JPEG size hinting は危険なので使わない方が良いと誤解する人が出そうなので勝手に補足します。</p>

<h1 id="define-jpeg-size-とは:8297ce3a5ed4594f91a307954f292784">-define jpeg:size とは？</h1>

<h2 id="jpeg-のデータの持ち方:8297ce3a5ed4594f91a307954f292784">JPEG のデータの持ち方</h2>

<p>JPEG は画像の周波数成分のデータを保持していて、JPEG の Decode では波を合成する事でビットマップ画像に戻します。尚、8x8 単位で画像をグリッド分割してこの処理をします。</p>

<p>(参考イメージ)
<center> <img src="/2016/01/08/dct8x8-600.png" /> </center>
引用) <a href="https://www.cl.cam.ac.uk/teaching/1011/R08/jpeg/acs10-jpeg.pdf">https://www.cl.cam.ac.uk/teaching/1011/R08/jpeg/acs10-jpeg.pdf</a></p>

<h2 id="scale-factor-つきでデコード:8297ce3a5ed4594f91a307954f292784">scale factor つきでデコード</h2>

<p>元のサイズの画像データに変換する場合と比べて、手間を増やさず <sup>1</sup>&frasl;<sub>2</sub>, <sup>1</sup>&frasl;<sub>4</sub>, <sup>1</sup>&frasl;<sub>8</sub> サイズの画像データに変換できます。高周波成分を見なくて済む上に変換後のサイズが小さい事から、むしろより少ない手間でさえあります。</p>

<p><center> <img src="/2016/01/08/dct8x8-4-1-600.png" /> </center></p>

<p>大きなサイズの画像からサムネール画像を生成するのに、一般的なリサイズのアルゴリズムを使わずにいきなり <sup>1</sup>&frasl;<sub>2</sub>, <sup>1</sup>&frasl;<sub>4</sub>, <sup>1</sup>&frasl;<sub>8</sub> の画像に変換、デコード出来ます。</p>

<p>ImageMagick (から利用する libjpeg) が 2,4,8 のように 2^n に限っているのは、波の合成(iDCT)の高速化で FFT を使う都合でしょう。</p>

<h2 id="やっている事:8297ce3a5ed4594f91a307954f292784">やっている事</h2>

<p>リサイズ後の大きさに近くなるよう scale factor を指定して JPEG を Decode し。そこからリサイズする事で、メモリやCPUを節約します。</p>

<h1 id="jpeg-size-hinting-の動作イメージ:8297ce3a5ed4594f91a307954f292784">JPEG size hinting の動作イメージ</h1>

<p>こちらに詳しいです。</p>

<ul>
<li>本当は速いImageMagick: サムネイル画像生成を10倍速くする方法

<ul>
<li><a href="http://blog.mirakui.com/entry/20110123/1295795409">http://blog.mirakui.com/entry/20110123/1295795409</a></li>
</ul></li>
</ul>

<h2 id="小さくリサイズする場合:8297ce3a5ed4594f91a307954f292784">小さくリサイズする場合</h2>

<ul>
<li><p>普通にリサイズ (-define jpeg:size 無し)
<center> <img src="/2016/01/08/resize1.png" /> </center></p></li>

<li><p>小さいサイズでデコードしてリサイズ (-define jpeg:size 有り)
<center> <img src="/2016/01/08/resize2.png" /> </center></p></li>
</ul>

<p>処理は減るしメモリも少ないし、パフォーマンス的には良い事づくめ。</p>

<h2 id="大きくリサイズする場合-予想:8297ce3a5ed4594f91a307954f292784">大きくリサイズする場合 (予想)</h2>

<p>問題にしているケースです。</p>

<ul>
<li><p>普通にリサイズ (-define jpeg:size 無し)
<center> <img src="/2016/01/08/resize3.png" /> </center></p></li>

<li><p>大きなサイズでデコードしてリサイズ (-define jpeg:size 有り)
<center> <img src="/2016/01/08/resize4.png" /> </center></p></li>
</ul>

<p>という動作が予想できます。1.5倍のメモリを使うという話も 2, 4, 8 倍で丁度良いサイズになる事はあまりないので、そこそこ話が合います。</p>

<h3 id="実際の動き:8297ce3a5ed4594f91a307954f292784">実際の動き</h3>

<p>jpeg_info の output_width, output_height を表示させて確認したところ、拡大する時には最大でも2倍指定で Decode するようです。どんなに元画像とのサイズの差をつけても 4, 8 倍にはなりませんでした。</p>

<h1 id="とりあえず結論:8297ce3a5ed4594f91a307954f292784">とりあえず結論</h1>

<p>小さくリサイズする時だけ -define jpeg:size をつけるよう気をつければ良いと思います。ただしリサイズアルゴリズムとは処理が異なるので、画質的に大丈夫か確認した方が良いでしょう。</p>

<h1 id="課題が残ってる:8297ce3a5ed4594f91a307954f292784">課題が残ってる</h1>

<p>コード的にはもやもやしてるので、もう少し追います。</p>

<ul>
<li>ReadJPEGImage (coders/jpeg.c)

<ul>
<li><a href="http://gt.awm.jp/ImageMagick-6.9.3-0/S/1372.html#L1105">http://gt.awm.jp/ImageMagick-6.9.3-0/S/1372.html#L1105</a>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%">      <span style="color: #f8f8f2">jpeg_info.scale_num</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1U</span><span style="color: #f8f8f2">;</span>
      <span style="color: #f8f8f2">jpeg_info.scale_denom</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">scale_factor;</span>
      <span style="color: #f8f8f2">jpeg_calc_output_dimensions(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">jpeg_info);</span>
</pre></div>
</li>
</ul></li>
</ul>

<p>拡大する場合は scale_num に数値を入れて scale_denom を 1 にする必要があるはずで、縮小するケースしか対応してないように見えますね。。</p>

  </section>
</article>

</main>


</div>

<footer>
  <div class="container">
    <span class="copyright">&copy; 2016  awm-Tech - <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
  </div>
</footer>

</body>
</html>


<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">
<meta name="generator" content="Hugo 0.16-DEV" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type="text/css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="AWM TechNotes">
<title>Blog の Deploy で Circle CI - AWM TechNotes</title>
</head>
<body>

<header>
  <div class="container">
    <a class="path" href="http://blog.awm.jp/">[AWM TechNotes]</a>
    <span class="caret"># _</span>
  </div>
</header>

<div class="container">


<main role="main" class="article">
  
<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2016-01-02">January 02, 2016</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="http://blog.awm.jp/categories/circleci">CircleCI</a>

    </span>


    <br>
    <span class="key">tags:</span>
    <span class="val">

        <a href="http://blog.awm.jp/tags/blog">Blog</a>

        <a href="http://blog.awm.jp/tags/github">Github</a>

        <a href="http://blog.awm.jp/tags/circleci">CircleCI</a>

    </span>

  </div>
  <h1 class="headline" itemprop="headline">Blog の Deploy で Circle CI</h1>
  <section class="body" itemprop="articleBody">
    

<h1 id="blog-の-deploy-で-circle-ci:74a620a9653e59d29d4e0cbb59ac7a79">Blog の Deploy で Circle CI</h1>

<p>昨日の時点では Markdown ファイルの編集後に、make install する事でブログサイトに HTML をデプロイしますが、今回、Markdown を git commit したら自動でデプロイされるべく、Circle CI に連携の設定を入れました。</p>

<h1 id="はじめに:74a620a9653e59d29d4e0cbb59ac7a79">はじめに</h1>

<p>前回は、awmcorp に markdown 等の blog のソースを置いてましたが、権限設定が面倒なので、awmlabs アカウントにレポジトリをまとめました。</p>

<ul>
<li>× <a href="https://github.com/awmcorp/blog.awm.jp">https://github.com/awmcorp/blog.awm.jp</a></li>
<li>○ <a href="https://github.com/awmlabs/blog.awm.jp">https://github.com/awmlabs/blog.awm.jp</a> blog のソース</li>
<li><a href="https://github.com/awmlabs/awmlabs.github.io">https://github.com/awmlabs/awmlabs.github.io</a> blog の公開ファイル</li>
</ul>

<h1 id="circle-yaml:74a620a9653e59d29d4e0cbb59ac7a79">circle.yaml</h1>

<p>連携時にどういうコマンドを実行するかの指定ですが、nobu666 神のファイルをコピペして、自分のとこに書き換えました。</p>

<ul>
<li><a href="https://github.com/nobu666/nobu666.com/blob/master/circle.yml">https://github.com/nobu666/nobu666.com/blob/master/circle.yml</a></li>
<li><a href="https://github.com/awmlabs/blog.awm.jp/blob/master/circle.yml">https://github.com/awmlabs/blog.awm.jp/blob/master/circle.yml</a></li>
</ul>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #ae81ff">machine</span><span style="color: #f8f8f2">:</span>
  <span style="color: #ae81ff">timezone</span><span style="color: #f8f8f2">:</span> <span style="color: #ae81ff">Asia/Tokyo</span>

<span style="color: #ae81ff">checkout</span><span style="color: #f8f8f2">:</span>
  <span style="color: #ae81ff">post</span><span style="color: #f8f8f2">:</span>
    <span style="color: #f8f8f2">-</span> <span style="color: #ae81ff">git submodule update --init --recursive</span>

<span style="color: #ae81ff">dependencies</span><span style="color: #f8f8f2">:</span>
  <span style="color: #ae81ff">pre</span><span style="color: #f8f8f2">:</span>
    <span style="color: #f8f8f2">-</span> <span style="color: #ae81ff">go get -v github.com/spf13/hugo</span>
    <span style="color: #f8f8f2">-</span> <span style="color: #ae81ff">git config --global user.name &quot;awm labs&quot;</span>
    <span style="color: #f8f8f2">-</span> <span style="color: #ae81ff">git config --global user.email &quot;labs@awm.jp&quot;</span>

<span style="color: #ae81ff">test</span><span style="color: #f8f8f2">:</span>
  <span style="color: #ae81ff">override</span><span style="color: #f8f8f2">:</span>
   <span style="color: #f8f8f2">-</span> <span style="color: #ae81ff">echo</span>

<span style="color: #ae81ff">deployment</span><span style="color: #f8f8f2">:</span>
  <span style="color: #ae81ff">master</span><span style="color: #f8f8f2">:</span>
    <span style="color: #ae81ff">branch</span><span style="color: #f8f8f2">:</span> <span style="color: #ae81ff">master</span>
    <span style="color: #ae81ff">commands</span><span style="color: #f8f8f2">:</span>
      <span style="color: #f8f8f2">-</span> <span style="color: #ae81ff">git clone git@github.com:awmlabs/awmlabs.github.io.git public</span>
      <span style="color: #f8f8f2">-</span> <span style="color: #ae81ff">hugo</span>
      <span style="color: #f8f8f2">-</span> <span style="color: #ae81ff">cd public &amp;&amp; git add . &amp;&amp; git commit -m &quot;[ci skip] publish&quot;; if [ $? -eq 0 ]; then git push origin master; else :; fi</span>
</pre></div>


<p>ありがとう、ありがとう。</p>

<h1 id="circle-ci-アカウント作成:74a620a9653e59d29d4e0cbb59ac7a79">Circle CI アカウント作成</h1>

<p>連携したい Github アカウントで Github にログインしておいて。Circle CI のページにアクセスして、Circle CI のページで SignUp すると連携用アカウントが作れるっぽいです。
 * <a href="https://circleci.com/">https://circleci.com/</a></p>

<p>尚、Github で所属する組織(Organizatins)全てのアクセス権を要求するので、色んな組織に所属するようなアカウントでの連携は厳しい。という人は新しい Github アカウントを作って設定すると良いかも。</p>

<p>Github API 的に組織ごとのオンオフ出来ないそうで。アカウント単位での認証だし仕方なさそう。あと組織(Organization) 側で Circle CI との連携は切る事も出来るので、融通が効く場合はそういう手もあるそうです。</p>

<h1 id="circle-ci-での連携設定:74a620a9653e59d29d4e0cbb59ac7a79">Circle CI での連携設定</h1>

<ul>
<li>Add Project で監視するレポジトリを選択します。</li>
<li>Project Settings の Permissions (SSH, API, AWS のでなく、唯の Permissions) から Authorize ＞ Create and add とボタンを押してく。</li>
<li><a href="https://github.com/settings/applications">https://github.com/settings/applications</a> で連携を確認 (revoke 押すと面倒なので気をつけて)</li>
</ul>

<p>(あと一手間あった気がするので、思い出したら後で追記します)</p>

<h1 id="異なる-github-アカウントでの連携-推測:74a620a9653e59d29d4e0cbb59ac7a79">異なる Github アカウントでの連携 (推測)</h1>

<p>同じアカウントであれば。 Permission 設定でボタン一発ですが、アカウントが違うレポジトリの場合は、ssh-keygen -f id<em>rsa</em>(アカウント名) で passphrase 空で作成して秘密鍵と公開鍵を、以下の URL に登録すれば出来そうな気もしますが、気のせいでした。
 * <a href="https://circleci.com/gh/">https://circleci.com/gh/</a>&lt;ユーザor組織名&gt;/&lt;リポジトリ名&gt;/edit#ssh
 * <a href="https://github.com/">https://github.com/</a>&lt;ユーザor組織名&gt;/&lt;リポジトリ名/settings/keys</p>

<p>そのうち必要に迫られたら、もう少し試行錯誤します。</p>

<h1 id="備考:74a620a9653e59d29d4e0cbb59ac7a79">備考</h1>

<ul>
<li>当初、作りたてのレポジトリが見えなくていつの間にか見えたので反映に時間がかかるのかと思いましたが、普通はすぐ反映されるそうです。謎です。</li>
<li>別アカウントでの連携をしたかったけど、push で marked as read only のエラーの壁を越えられなかったので、そのうち挑戦したい。</li>
</ul>

  </section>
</article>

</main>


</div>

<footer>
  <div class="container">
    <span class="copyright">&copy; 2016  AWM TechNotes - <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
  </div>
</footer>

</body>
</html>


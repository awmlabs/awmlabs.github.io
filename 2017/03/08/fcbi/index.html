<!doctype html5>
<html lang="ja-JP">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="awmlabs"><meta name="theme-color" content="#2d2d2d">
  <meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@yoya"><meta property="og:type" content="blog">
  <meta property="og:title"content="エッジ判定型超解像アルゴリズム FCBI (Fast curvature based interpolation) 後編:アルゴリズム詳解 | awm-Tech">
  <meta property="og:url" content="https://awmlabs.github.io/">
  <meta property="og:site_name" content="Base16">
  
  
  <link rel="stylesheet" href="https://awmlabs.github.io/style.4bd310721b0b4df95fea15312794ee594430a1e9407d68d9efa75b4357f918950914b350d1b9f6bfe21dda649a99e6a8a71fbc6542f7b4b87465b936b56a4fed.css" type="text/css"integrity="sha512-S9MQchsLTflf6hUxJ5TuWUQwoelAfWjZ76dbQ1f5GJUJFLNQ0bn2v&#43;Id2mSameaopx&#43;8ZUL3tLh0Zbk2tWpP7Q==" >
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type="text/css">
  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="awm-Tech">
  <link rel="shortcut icon" type="image/x-icon" href="https://awmlabs.github.io/favicon.ico">
  <title>エッジ判定型超解像アルゴリズム FCBI (Fast curvature based interpolation) 後編:アルゴリズム詳解 - awm-Tech</title>
</head>

  <body>
    <header>
  <div class="container clearfix">
    <a class="path" href="https://awmlabs.github.io/">[awm-Tech]</a>
    <span class="caret">#_</span>
    <div class="right">
      
      <a class="path" href="https://awmlabs.github.io/search">/Search</a>
    </div>
  </div>
</header>

      <div class="container">
        <main role="main" class="article">
          

<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">
    <div style="float:left;">  
<div id="fb-root"></div>
<script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1";
        fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-like" data-href=" https://blog.awm.jp/2017/03/08/fcbi/" data-colorscheme="light" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
<a href="https://b.hatena.ne.jp/entry/blog.awm.jp/2017/03/08/fcbi/" class="hatena-bookmark-button" data-hatena-bookmark-title="エッジ判定型超解像アルゴリズム FCBI (Fast curvature based interpolation) 後編:アルゴリズム詳解" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリー
をはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://blog.awm.jp/2017/03/08/fcbi/" data-lang="ja" data-hashtags="awmtech">ツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
 </div>

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2017-03-08">March 08, 2017</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="https://awmlabs.github.io/categories/graphics">Graphics</a>

    </span>


    <br>
    <span class="key">tags:</span>
    <span class="val">

        <a href="https://awmlabs.github.io/tags/fcbi">FCBI</a>

        <a href="https://awmlabs.github.io/tags/superresolution">SuperResolution</a>

    </span>

  </div>
  <h1 class="headline" itemprop="headline">エッジ判定型超解像アルゴリズム FCBI (Fast curvature based interpolation) 後編:アルゴリズム詳解</h1>

  <section class="body" itemprop="articleBody">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#ポイント">ポイント</a></li>
    <li><a href="#注意点">注意点</a>
      <ul>
        <li><a href="#カラー対応">カラー対応</a></li>
        <li><a href="#フィルタ行列">フィルタ行列</a></li>
        <li><a href="#abs---h1-h2">abs - h1, h2</a></li>
      </ul>
    </li>
    <li><a href="#既存のメソッドとの比較">既存のメソッドとの比較</a>
      <ul>
        <li><a href="#nearest-neighbor">Nearest-Neighbor</a></li>
        <li><a href="#bi-linear">Bi-Linear</a></li>
        <li><a href="#fcbi">FCBI</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#大まかなアルゴリズム">大まかなアルゴリズム</a>
      <ul>
        <li><a href="#phase1">Phase1</a></li>
        <li><a href="#phase2">Phase2</a></li>
        <li><a href="#phase3">Phase3</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#phase1-ピクセルを拡げる">Phase1: ピクセルを拡げる</a></li>
    <li><a href="#phase2-斜め方向からピクセルを埋める">Phase2: 斜め方向からピクセルを埋める</a>
      <ul>
        <li><a href="#エッジ判定">エッジ判定</a></li>
        <li><a href="#非エッジの場合">非エッジの場合</a></li>
        <li><a href="#エッジの場合">エッジの場合</a></li>
      </ul>
    </li>
    <li><a href="#phase3-縦横方向からピクセルを埋める">Phase3: 縦横方向からピクセルを埋める</a>
      <ul>
        <li><a href="#エッジ判定-1">エッジ判定</a></li>
        <li><a href="#非エッジの場合-1">非エッジの場合</a></li>
        <li><a href="#エッジの場合-1">エッジの場合</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#phase1-ピクセルを拡げる-1">Phase1: ピクセルを拡げる</a></li>
    <li><a href="#phase2-斜め方向からピクセルを埋める-1">Phase2: 斜め方向からピクセルを埋める</a></li>
    <li><a href="#phase3-縦横方向からピクセルを埋める-1">Phase3: 縦横方向からピクセルを埋める</a></li>
  </ul>

  <ul>
    <li><a href="#問題1-width1-の線">問題1) width:1 の線</a></li>
    <li><a href="#改善">改善</a></li>
    <li><a href="#問題2-星空">問題2) 星空</a></li>
  </ul>
</nav>
    <h1 id="はじめに">はじめに</h1>
<p>インターフェース誌2015年6月号「超解像アルゴリズム」の記事を元に、分かりにくかった点を補足しつつ、全面的に一から解説し直します。</p>
<p>ICBI や iNEDI といったより良い手法もありますが、FCBI はそれらより処理が軽いので使い道はありますし、ICBI は FCBI をベースにしているので知っておいて損はないです。</p>
<p>尚、こちらのエントリの続きです。</p>
<ul>
<li>エッジ判定型超解像アルゴリズム FCBI (Fast curvature based interpolation) 前編:デモプログラムの使い方
<ul>
<li><a href="https://blog.awm.jp/2017/03/07/fcbi/">https://blog.awm.jp/2017/03/07/fcbi/</a>
<ul>
<li><a href="https://app.awm.jp/image.js/fcbi.html">https://app.awm.jp/image.js/fcbi.html</a> (デモ)</li>
<li><a href="https://github.com/yoya/image.js/blob/master/fcbi.js">https://github.com/yoya/image.js/blob/master/fcbi.js</a> (ソースコード)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>デモを見た方が実感が湧くので、出来ればこの記事の前に前編をお読み下さい。</p>
<h1 id="アルゴリズム概要">アルゴリズム概要</h1>
<p>本家はこちらです。</p>
<ul>
<li>ICBI page
<ul>
<li><a href="http://www.andreagiachetti.it/icbi/">http://www.andreagiachetti.it/icbi/</a>
<ul>
<li><a href="http://www.andreagiachetti.it/icbi/icbi.zip">http://www.andreagiachetti.it/icbi/icbi.zip</a> (matlab 実装)</li>
<li><a href="https://github.com/yoya/ICBI/tree/master/icbi">https://github.com/yoya/ICBI/tree/master/icbi</a> (zip を展開したもの。GPLv2 です)
<ul>
<li><a href="https://github.com/yoya/ICBI/blob/master/icbi/icbi.m">icbi/icbi.m</a></li>
<li><a href="https://github.com/yoya/ICBI/blob/master/ICBICUDA/interpolation_fcbi_kernel.cu">ICBICUDA/interpolation_fcbi_kernel.cu</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ICBI の 1st step が FCBI なので、その解説や実装も見つかります。</p>
<h2 id="ポイント">ポイント</h2>
<ul>
<li>エッジを残しつつエネルギーが最小になるよう選択的に補間する
<ul>
<li>エッジの場所は勾配(輝度の微分)の少ない軸方向で補間する</li>
<li>非エッジは勾配の変化(輝度の2次微分)が少ない軸方向で補完</li>
</ul>
</li>
<li>倍のサイズ(正確には倍-1)への拡大のみ。スケール微調整は不可
<ul>
<li>尚、本家の参照実装(icbi.m)の拡大は (SIZE * 2^ZK) - (2^ZK-1) に対応しています。(ZK は zoom factor)</li>
</ul>
</li>
<li>画像によって適切な値が異なる閾値 TM(Maximun edge step) を調整する必要がある。手動なり自動なり</li>
<li>モノクロ画像のアルゴリズムなので、色差によるエッジは処理に反映されない</li>
<li>イラスト画像は少し苦手 (最後の方で解説)</li>
</ul>
<h2 id="注意点">注意点</h2>
<h3 id="カラー対応">カラー対応</h3>
<p>FCBI はモノクロ画像のアルゴリズムなので、カラフルな画像に対応する為にサンプルコードでは RGBA から計算した輝度 Y を用いました。JPEG の YCbCr の計算式に alpha を乗算します。</p>
<ul>
<li><a href="https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L75">https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L75</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">lumaFromRGBA</span>(<span style="color:#a6e22e">rgba</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> [<span style="color:#a6e22e">r</span>,<span style="color:#a6e22e">g</span>,<span style="color:#a6e22e">b</span>,<span style="color:#a6e22e">a</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">rgba</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.299</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.587</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">g</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.114</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">b</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">255</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></li>
</ul>
<h3 id="フィルタ行列">フィルタ行列</h3>
<p>インターフェース誌の記事では非エッジの勾配を調べるフィルタ行列との演算がテンソル積(<img src="../tensor_product.png" alt="バツをマルで囲う記号" align=center />)で示されますが、単なる畳み込みの計算なのでプログラム的には簡単です。</p>
<p>つまり、近辺のピクセルの場所に応じて重み付けをした足し算です。</p>
<h3 id="abs---h1-h2">abs - h1, h2</h3>
<p>インターフェース誌の記事も FCBI を説明する様々な論文でも端折ってますが、非エッジの勾配を比較するのは h1 &lt; h2 でなく abs(h1) &lt; abs(h2) です。 (このh1,h2 はインターフェース誌だと H1, H2。本家の参照実装だと展開されたベタな数式、論文だと I<sub>11</sub>, I<sub>22</sub>)</p>
<ul>
<li><a href="https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L232">https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L232</a></li>
<li><a href="https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L297">https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L297</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">h1</span>) <span style="color:#f92672">&lt;</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">h2</span>)) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba1</span>, <span style="color:#a6e22e">rgba4</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba2</span>, <span style="color:#a6e22e">rgba3</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></li>
</ul>
<p>直感的にも abs を取らないと白い塗りと黒い塗りで結果が変わるでしょうし、本家の参照実装(icbi.m)では abs で括っています。</p>
<ul>
<li><a href="https://github.com/yoya/ICBI/blob/master/icbi/icbi.m#L289">https://github.com/yoya/ICBI/blob/master/icbi/icbi.m#L289</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>( <span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">IMGEXP</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#a6e22e">s</span>,<span style="color:#a6e22e">j</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span><span style="color:#f92672">+</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>)) <span style="color:#f92672">+</span> <span style="color:#a6e22e">IMGEXP</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span><span style="color:#f92672">+</span><span style="color:#a6e22e">s</span>,<span style="color:#a6e22e">j</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>)) <span style="color:#f92672">+</span> <span style="color:#a6e22e">IMGEXP</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#a6e22e">s</span>,<span style="color:#a6e22e">j</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span><span style="color:#f92672">-</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>)) <span style="color:#f92672">+</span> <span style="color:#a6e22e">IMGEXP</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span><span style="color:#f92672">-</span><span style="color:#a6e22e">s</span>,<span style="color:#a6e22e">j</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>)) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">p2</span>) <span style="color:#f92672">-</span> (<span style="color:#ae81ff">6</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">p1</span>)) <span style="color:#f92672">&gt;</span> ...
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">IMGEXP</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span><span style="color:#f92672">+</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>),<span style="color:#a6e22e">j</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#a6e22e">s</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">IMGEXP</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>),<span style="color:#a6e22e">j</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span><span style="color:#f92672">-</span><span style="color:#a6e22e">s</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">IMGEXP</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span><span style="color:#f92672">-</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>),<span style="color:#a6e22e">j</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#a6e22e">s</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">IMGEXP</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>),<span style="color:#a6e22e">j</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span><span style="color:#f92672">+</span><span style="color:#a6e22e">s</span>) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">p1</span>) <span style="color:#f92672">-</span> (<span style="color:#ae81ff">6</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">p2</span>)) )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">IMGEXP</span>(<span style="color:#a6e22e">i</span>,<span style="color:#a6e22e">j</span>) <span style="color:#f92672">=</span> <span style="color:#a6e22e">p1</span>;</span></span></code></pre></div></li>
</ul>
<h2 id="既存のメソッドとの比較">既存のメソッドとの比較</h2>
<p>画像の拡大はピクセルを広げて出来た隙間をどう埋めるのかが勝負です。色んな方法があります。</p>
<center> <img src="../test-3x2Dotty.png" align="top"/> <span style="padding: 1em;"> => </span> <img src="../testPhase1-5x3Dotty.png" align="center"/> </center>
<h3 id="nearest-neighbor">Nearest-Neighbor</h3>
<p>恐らくもっとも速い方法です。近隣(Nearest-Neighbor)のピクセルをコピーします。</p>
<center> <img src="../test-NN-5x3Dotty.png" /> </center>
<p>ちなみに丁度2倍の 6x4 だとこうなります。</p>
<center> <img src="../test-NN-6x4Dotty.png" /> </center>
<h3 id="bi-linear">Bi-Linear</h3>
<p>線形(Linear)の計算で補間します。中学校で習う a と b の間の p 点 みたいな計算です。
丁度２倍にする例だと隣のピクセルを足して割る。つまり4隅または隣2つの平均値を用います。</p>
<center> <img src="../test-BL-5x3Dotty.png" /> </center>
<p>RGB 値が色味に対して線形では無いので違和感がありますが、そこは目を瞑って頂ければ。。RGB の数値はちゃんと平均、真ん中の値です。</p>
<h3 id="fcbi">FCBI</h3>
<p>Bi-Linear の亜種とも言えます。Bi-Linear だと単純に上下左右の４つから混ぜますが、FCBI はエッジをなるべく残すよう、４つのうち２つを選択して混ぜます。</p>
<h1 id="fcbi-の全体的な流れ">FCBI の全体的な流れ</h1>
<p>３つのフェーズで処理します。
Phase1 と Phase2 は同時に実行できますが、分かりやすいよう便宜的に分けます。</p>
<table>
<thead>
<tr>
<th>元画像</th>
<th>Phase1</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="../test-3x2Dotty.png" /></td>
<td><img src="../testPhase1-5x3Dotty.png" /></td>
</tr>
<tr>
<td>Phase2</td>
<td>Phase3</td>
</tr>
<tr>
<td><img src="../testPhase2-5x3Dotty.png" /></td>
<td><img src="../testPhase3-5x3Dotty.png" /></td>
</tr>
</tbody>
</table>
<h2 id="大まかなアルゴリズム">大まかなアルゴリズム</h2>
<p>詳細は後にして、まず処理の大雑把な流れです。</p>
<h3 id="phase1">Phase1</h3>
<ul>
<li>ピクセルを2倍の座標で再配置する</li>
</ul>
<h3 id="phase2">Phase2</h3>
<ul>
<li>斜め隣を見てエッジかどうか判定する
<ul>
<li>非エッジの場合
<ul>
<li>周辺８ピクセルから勾配の変化率を見て、変化が少ない方の２ピクセルを混ぜる</li>
</ul>
</li>
<li>エッジの場合
<ul>
<li>斜め隣の２軸のうち勾配が少ない方の２ピクセルを混ぜる</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="phase3">Phase3</h3>
<ul>
<li>上下左右の隣を見てエッジかどうか判定する
<ul>
<li>非エッジの場合
<ul>
<li>周辺８ピクセルから上下左右の勾配の変化率を見て、変化が少ない方の２ピクセルを混ぜる</li>
</ul>
</li>
<li>エッジの場合
<ul>
<li>上下、左右の２軸のうち勾配が少ない方の２ピクセルを混ぜる</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="各-phase-の詳細">各 Phase の詳細</h1>
<h2 id="phase1-ピクセルを拡げる">Phase1: ピクセルを拡げる</h2>
<p>単純にピクセルを2倍の座標で配置し直します。</p>
<center> <img src="../test-3x2Dotty.png" align="top"/> <span style="padding: 1em;"> => </span> <img src="../testPhase1-5x3Dotty.png" align="center"/> </center>
- https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L173
   - (読み易くする為、エッジ表示モード(edgeMode) の処理は省略)
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">drawFCBI_Phase1</span>(<span style="color:#a6e22e">srcImageData</span>, <span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">edgeMode</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dstWidth</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dstImageData</span>.<span style="color:#a6e22e">width</span>, <span style="color:#a6e22e">dstHeight</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dstImageData</span>.<span style="color:#a6e22e">height</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dstY</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">dstY</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">dstHeight</span> ; <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dstX</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">dstX</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">dstWidth</span> ; <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">srcX</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dstX</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;  <span style="color:#75715e">// srcX * 2 = dstX
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">srcY</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dstY</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getRGBA</span>(<span style="color:#a6e22e">srcImageData</span>, <span style="color:#a6e22e">srcX</span>, <span style="color:#a6e22e">srcY</span>);
</span></span><span style="display:flex;"><span>	    <span style="color:#a6e22e">setRGBA</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span>, <span style="color:#a6e22e">dstY</span>, <span style="color:#a6e22e">rgba</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>この手の処理は dstImage の縦横座標を元にループ処理をして、srcImage の対応する色を引っ張ってくるのが王道です。
ただ、今回のケースは丁度2倍でキリが良いので srcImage でループしても良いです。</p>
<ul>
<li>もう一つの方法
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">drawFCBI_Phase1</span>(<span style="color:#a6e22e">srcImageData</span>, <span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">edgeMode</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">srcWidth</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">srcImageData</span>.<span style="color:#a6e22e">width</span>, <span style="color:#a6e22e">srcHeight</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">srcImageData</span>.<span style="color:#a6e22e">height</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">srcY</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">srcY</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">srcHeight</span> ; <span style="color:#a6e22e">srcY</span><span style="color:#f92672">+=</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">srcX</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">srcX</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">srcWidth</span> ; <span style="color:#a6e22e">srcX</span><span style="color:#f92672">+=</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dstX</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">srcX</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>;  <span style="color:#75715e">// srcX * 2 = dstX
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dstY</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">srcY</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getRGBA</span>(<span style="color:#a6e22e">srcImageData</span>, <span style="color:#a6e22e">srcX</span>, <span style="color:#a6e22e">srcY</span>);
</span></span><span style="display:flex;"><span>	    <span style="color:#a6e22e">setRGBA</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span>, <span style="color:#a6e22e">dstY</span>, <span style="color:#a6e22e">rgba</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></li>
</ul>
<p>srcImage と dstImage の座標変換が整数倍じゃない時に破綻するので、習慣として自分は dstX, dstY でループしてます。(まぁ性能次第で適当に切り替えましょう)</p>
<h2 id="phase2-斜め方向からピクセルを埋める">Phase2: 斜め方向からピクセルを埋める</h2>
<center> <img src="../phase2-l1234-3x3Dotty-14.png" align="center"/> <span style="padding: 1em;"> or </span> <img src="../phase2-l1234-3x3Dotty-23.png" align="center" /> </center>
<p>l1, l4、又は l2, l3 の平均値を真ん中のピクセルに埋めます。ここからの長々とした解説は、このどちらのピクセルを埋めるかを判断する処理についてです。</p>
<h3 id="エッジ判定">エッジ判定</h3>
<center>
  <img src="../phase2-l1-l4-3x3Dotty.png" align="center" /> v1 = abs(l1 - l4) <span style="padding:1em;">  </span> <img src="../phase2-l2-l3-3x3Dotty.png" align="center" /> v2 = abs(l2 - l3)
<p><img src="../phase2-p1-p2-3x3Dotty.png" align="center" /> abs(p1 - p2) ; p1=(l1+l4)/2, p2=(l2+l3)/2;</p>
</center>
<p>隣り合うピクセルの輝度に急激な変化があればエッジで、それ以外を非エッジだと判定します。</p>
<ul>
<li><a href="https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L196">https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L196</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/*  l1     l2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *      x  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  l3     l4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getRGBA</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getRGBA</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getRGBA</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getRGBA</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lumaFromRGBA</span>(<span style="color:#a6e22e">rgba1</span>); <span style="color:#75715e">// RGBA から輝度 Y を算出
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lumaFromRGBA</span>(<span style="color:#a6e22e">rgba2</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lumaFromRGBA</span>(<span style="color:#a6e22e">rgba3</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lumaFromRGBA</span>(<span style="color:#a6e22e">rgba4</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">v1</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">l1</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">l4</span>);   <span style="color:#75715e">// 斜め方向の勾配
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">v2</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">l2</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">l3</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p1</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">l1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l4</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;       <span style="color:#75715e">// 斜め隣の平均
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p2</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">l2</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l3</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;       <span style="color:#75715e">// つまり p1 - p2 は斜め２軸の勾配
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">v1</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">TM</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">v2</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">TM</span>) <span style="color:#f92672">&amp;&amp;</span> (Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">p1</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">p2</span>) <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">TM</span>)) {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 非エッジとして処理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// エッジとして処理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div></li>
</ul>
<h3 id="非エッジの場合">非エッジの場合</h3>
<p>補完するピクセルをどれにするか判断するのに斜め隣のピクセルだけでなく、もう少し広めのピクセルを見ます。非エッジの時は隣のピクセルの差分が少ないので仕方がないのと、単なる勾配でなく勾配の変化をみる為です。</p>
<table>
<thead>
<tr>
<th>h1 のフィルタ</th>
<th>h2 のフィルタ</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="../phase2-h1Filter-7x7Dotty.png" /></td>
<td><img src="../phase2-h2Filter-7x7Dotty.png" /></td>
</tr>
</tbody>
</table>
<p>補間したいピクセルの周辺の輝度を上記の重み付けで計算を行い、h1 と h2 の大小で勾配の変化の小さい向きを判定します。</p>
<p>例えば、こういうグラデーションがあるとします。</p>
<img src="../phase2-hSample-7x7Dotty.png">
<table>
<thead>
<tr>
<th>h1のなぞり方</th>
<th>h2のなぞり方</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="../phase2-h1Sample-7x7Dotty.png"></td>
<td><img src="../phase2-h2Sample-7x7Dotty.png"></td>
</tr>
</tbody>
</table>
<p>実際の計算は以下のようになります。</p>
<pre tabindex="0"><code>h1 = (6 + 4 + 2) - 3 * (5 + 3) + (6 + 4 + 2) = 0
h2 = (3 + 3 + 3) - 3 * (4 + 4) + (5 + 5 + 5) = 0
</code></pre><p>この例だとグラデーションの勾配が全領域で一定なので変化率は h1, h2 で変わりません。(悪い例でした、すみません)</p>
<ul>
<li><a href="https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L217">https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L217</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_m1m3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_p1m3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_m3m1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// l_m1m1 = l1;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// l_p1m1 = l2;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_p3m1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_m3p1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// l_m1p1 = l3;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// l_p1p1 = l4;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_p3p1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_m1p3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_p1p3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">h1</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">l_m3p1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l_p1m3</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> (<span style="color:#a6e22e">l3</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l2</span>) <span style="color:#f92672">+</span> (<span style="color:#a6e22e">l_m1p3</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l4</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l_p3m1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">h2</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">l_m1m3</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l2</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l_p3p1</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> (<span style="color:#a6e22e">l1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l4</span>) <span style="color:#f92672">+</span> (<span style="color:#a6e22e">l_m3m1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l3</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l_p1p3</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">h1</span>) <span style="color:#f92672">&lt;</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">h2</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba1</span>, <span style="color:#a6e22e">rgba4</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba2</span>, <span style="color:#a6e22e">rgba3</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></li>
</ul>
<h3 id="エッジの場合">エッジの場合</h3>
<p>エッジであれば、斜め２軸の隣どうしを見て、その差が少ない方の２ピクセルを線形補完するだけです。</p>
<center> v1:<img src="../phase2-l1-l4-3x3Dotty.png" align="center" /> <span style="padding:1em;"> </span> v2:<img src="../phase2-l2-l3-3x3Dotty.png" align="center" /> </center>
<ul>
<li><a href="https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L267">https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L267</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">v1</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">v2</span>) { <span style="color:#75715e">// v1:abs(l1 - l4),  v2:abs(l2 - l3)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba1</span>, <span style="color:#a6e22e">rgba4</span>); <span style="color:#75715e">// l1, l4 の中間の値
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba2</span>, <span style="color:#a6e22e">rgba3</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></li>
</ul>
<h2 id="phase3-縦横方向からピクセルを埋める">Phase3: 縦横方向からピクセルを埋める</h2>
<center> <img src="../phase3-l1234-3x3Dotty-14.png" align="center"/>  <span style="padding:1em;"> or </span> <img src="../phase3-l1234-3x3Dotty-23.png" align="center" /> </center>
<p>Phase2 で参照するピクセルのあった斜め方向を左45度傾けて縦横にしただけです。
Phase2 とほぼ同じですので、図だけつけて細かい説明は省きます。</p>
<h3 id="エッジ判定-1">エッジ判定</h3>
<ul>
<li><a href="https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L268">https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L268</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/*     l2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  l1  x  l4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *     l3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getRGBA</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getRGBA</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span>  , <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getRGBA</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span>  , <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getRGBA</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lumaFromRGBA</span>(<span style="color:#a6e22e">rgba1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lumaFromRGBA</span>(<span style="color:#a6e22e">rgba2</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lumaFromRGBA</span>(<span style="color:#a6e22e">rgba3</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lumaFromRGBA</span>(<span style="color:#a6e22e">rgba4</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">v1</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">l1</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">l4</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">v2</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">l2</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">l3</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p1</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">l1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l4</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p2</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">l2</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l3</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">v1</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">TM</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">v2</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">TM</span>) <span style="color:#f92672">&amp;&amp;</span> (Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">p1</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">p2</span>) <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">TM</span>)) {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 非エッジとして処理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// エッジとして処理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div></li>
</ul>
<h3 id="非エッジの場合-1">非エッジの場合</h3>
<table>
<thead>
<tr>
<th>h1 のフィルタ</th>
<th>h2 のフィルタ</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="../phase3-h1Filter-3x5Dotty.png" /></td>
<td><img src="../phase3-h2Filter-5x3Dotty.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li><a href="https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L292">https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L292</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_m1m2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_p1m2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_m2m1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// l_z0m1 = l2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_p2m1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// l_m1z0 = l1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// l_p1z0 = l4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_m2p1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// l_z0p1 = l3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_p2p1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_m1p2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l_p1p2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getLuma</span>(<span style="color:#a6e22e">dstImageData</span>, <span style="color:#a6e22e">dstX</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">dstY</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">h1</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">l_p1m2</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l4</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l_p1p2</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> (<span style="color:#a6e22e">l2</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l3</span>) <span style="color:#f92672">+</span> (<span style="color:#a6e22e">l_m1m2</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l_m1p2</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">h2</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">l_m2m1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l2</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l_p2m1</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> (<span style="color:#a6e22e">l1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l4</span>) <span style="color:#f92672">+</span> (<span style="color:#a6e22e">l_m2p1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l3</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">l_p2p1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">h1</span>) <span style="color:#f92672">&lt;=</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">h2</span>)) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba1</span>, <span style="color:#a6e22e">rgba4</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba2</span>, <span style="color:#a6e22e">rgba3</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></li>
</ul>
<h3 id="エッジの場合-1">エッジの場合</h3>
<ul>
<li><a href="https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L312">https://github.com/yoya/image.js/blob/v1.5/fcbi.js#L312</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">v1</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">v2</span>) { <span style="color:#75715e">// v1:abs(l1 - l4),  v2:abs(l2 - l3)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba1</span>, <span style="color:#a6e22e">rgba4</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba2</span>, <span style="color:#a6e22e">rgba3</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></li>
</ul>
<h1 id="ドット画像でテスト">ドット画像でテスト</h1>
<p>実際の画像に適用してみます。</p>
<p><img src="../Opaopa.png" /> <img src="../Opaopa-Dotize.png" align="top" /></p>
<h2 id="phase1-ピクセルを拡げる-1">Phase1: ピクセルを拡げる</h2>
<p><img src="../OpaopaPhase1.png" /> <img src="../OpaopaPhase1-Dotize.png" align="top" /></p>
<h2 id="phase2-斜め方向からピクセルを埋める-1">Phase2: 斜め方向からピクセルを埋める</h2>
<p><img src="../OpaopaPhase2.png" /> <img src="../OpaopaPhase2-Dotize.png" align="top" /></p>
<h2 id="phase3-縦横方向からピクセルを埋める-1">Phase3: 縦横方向からピクセルを埋める</h2>
<p><img src="../OpaopaPhase3.png" /> <img src="../OpaopaPhase3-Dotize.png" align="top" /></p>
<p>気持ち悪いくらい、なめらかに補間されてます。</p>
<h1 id="イラストでのテスト">イラストでのテスト</h1>
<p>既存のリサイズ方式との比較表が、<a href="https://blog.awm.jp/2017/03/07/fcbi/">前編</a>の後半にありますが、改めて別のイラストで実験します。</p>
<img src="../Kotori.png" />
Copyright: https://twitter.com/myuton0407/status/693361955000549376
<pre tabindex="0"><code>% convert Kotori.png -filter box      -resize 200%x200% Kotori-box.png # N-Neighbor
% convert Kotori.png -filter triangle -resize 200%x200% Kotori-triangle.png # Bi-Linear
% convert Kotori.png -filter cubic    -resize 200%x200% Kotori-cubic.png
% convert Kotori.png -filter lanczos  -resize 200%x200% Kotori-lanczos.png
% convert Kotori.png -filter mitchell -resize 200%x200% Kotori-mitchell.png
</code></pre><p>ちなみに、ImageMagick の画像拡大のデフォルトが Mitchell です。</p>
<table>
<thead>
<tr>
<th>Nearest-Neighbor</th>
<th>Bi-Linear</th>
<th>Bi-Cubic (B,C = 1,0)</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="../Kotori-box.png"/></td>
<td><img src="../Kotori-triangle.png"/></td>
<td><img src="../Kotori-cubic.png"/></td>
</tr>
<tr>
<td>Lanczoz (lobes:3)</td>
<td>Mitchell-Netravali</td>
<td>FCBI (TM:12)</td>
</tr>
<tr>
<td><img src="../Kotori-lanczos.png"/></td>
<td><img src="../Kotori-mitchell.png"/></td>
<td><img src="../Kotori-fcbi.png"/></td>
</tr>
</tbody>
</table>
<p>ぱっと見では Mitchell-Netravali  フィルタが良い勝負をしていますが、細かいところまで見ると FCBI に分配があがります。</p>
<h1 id="fcbi-の弱点">FCBI の弱点</h1>
<h2 id="問題1-width1-の線">問題1) width:1 の線</h2>
<p>FCBI はグラデーションの無いベタ塗りの上に引いた width:1 の線が苦手です。実写の画像だと殆ど問題ないのですが、イラストだと結構このパターンが出てきます。</p>
<table>
<thead>
<tr>
<th>テスト画像</th>
<th>ドット拡大表示</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="../test00.png" /></td>
<td><img src="../test00-dotty.png" /></td>
</tr>
<tr>
<td><img src="../test01.png" /></td>
<td><img src="../test01-dotty.png" /></td>
</tr>
<tr>
<td><img src="../test02.png" /></td>
<td><img src="../test02-dotty.png" /></td>
</tr>
<tr>
<td><img src="../test03.png" /></td>
<td><img src="../test03-dotty.png" /></td>
</tr>
</tbody>
</table>
<p>これはエッジの時は近隣の４ピクセルしか見ない為です。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/*  l1     l2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *      x  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  l3     l4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">v1</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">v2</span>) { <span style="color:#75715e">// v1:abs(l1 - l4),  v2:abs(l2 - l3)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba1</span>, <span style="color:#a6e22e">rgba4</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rgba</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">meanRGBA</span>(<span style="color:#a6e22e">rgba2</span>, <span style="color:#a6e22e">rgba3</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>このケースだと v1(上記の例だと白-白) と v2（黒-黒) の差がなくなるので、
どちらを補間すれば良いのか判断がつかなくなります。</p>
<center> <img src="../fail-l1234-3x3-Dotty.png" /> </center>
<p>(v1 &lt; v2) の条件式なので、 l2, l3 (右肩上がりの斜め)を使ってしまいます。</p>
<p>つまり、グラデーションの少ないベタ塗り部分に右肩下がりの細い線があると、うまく補間できないという事です。</p>
<h2 id="改善">改善</h2>
<p>改善のエントリが長くなったので、別にしました。</p>
<ul>
<li>エッジ判定型超解像アルゴリズム FCBI (Fast curvature based interpolation) おまけ:アルゴリズム改造
<ul>
<li><a href="https://blog.awm.jp/2017/03/11/fcbi/">https://blog.awm.jp/2017/03/11/fcbi/</a></li>
</ul>
</li>
</ul>
<p>結果</p>
<p>元画像: <img src="../miku.png" /></p>
<table>
<thead>
<tr>
<th>FCBI オリジナル</th>
<th>改造 take1</th>
<th>改造 take2</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="../miku-v1.0.png" /></td>
<td><img src="../miku-v1.2.png" /></td>
<td><img src="../miku-v1.5.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>copyright: <a href="https://twitter.com/rityulate/status/772006898279120896">https://twitter.com/rityulate/status/772006898279120896</a></li>
</ul>
<p>途切れ途切れになっていた線が、スムーズに繋がりました。</p>
<h2 id="問題2-星空">問題2) 星空</h2>
<p>こちらの方が本質的な問題ですが、星空のように眩しい点が沢山ある時に勝手に繋がる事があります。</p>
<p><img src="../star01.jpg" align="center"/> =&gt; <img src="../star02-v1.0.png" align="top"/>(改造前) <span style="padding:1em;"> </span> <img src="../star02-v1.4.png" align="top"/>(改造後)</p>
<p>ただ、元の写真に無視できないレベルの歪みがあるので、高精度な写真だとまた話が違うかもしれません。</p>
<h1 id="さいごに">さいごに</h1>
<p>思った事をつらつらと。</p>
<ul>
<li>h1, h2 のフィルタは今後 ICBI に話を繋げる為に行列表現で考えた方が良いかも。</li>
<li>画像全体の明るさ次第で TM が極端に変わるので、ヒストグラム平均化した方がよさそう</li>
<li>輝度Yでなく色差も使った方が良いはず。イラストだと特に</li>
<li>FCBI のせいでは無いけれど、JPEG 画像のモアレが余計に目立って悲しい事もある</li>
</ul>
<p>漏れや間違いに気付き次第、なるべく全部直します。ご指摘頂けると幸いです。</p>
<h1 id="参考">参考</h1>
<ul>
<li>Interface 2015年6月号 (CQ出版)
<ul>
<li><a href="http://www.kumikomi.net/interface/contents/201506.php">http://www.kumikomi.net/interface/contents/201506.php</a></li>
</ul>
</li>
<li>ICBI page
<ul>
<li><a href="http://www.andreagiachetti.it/icbi/">http://www.andreagiachetti.it/icbi/</a></li>
</ul>
</li>
<li>Real time artifact-free image upscaling
<ul>
<li><a href="http://www.andreagiachetti.it/icbi/InterTIPmod2c.pdf">http://www.andreagiachetti.it/icbi/InterTIPmod2c.pdf</a></li>
</ul>
</li>
<li>Comparative Analysis of Edge Based Single Image Superresolution
<ul>
<li><a href="http://ijcttjournal.org/Volume10/number-5/IJCTT-V10P146.pdf">http://ijcttjournal.org/Volume10/number-5/IJCTT-V10P146.pdf</a></li>
</ul>
</li>
<li>Parameter Optimization Of Fast Curvature Based Interpolation Using Genetic Algorithm
<ul>
<li><a href="https://pdfs.semanticscholar.org/a61c/d74eefae6283f5d88ade1e241890f192d458.pdf">https://pdfs.semanticscholar.org/a61c/d74eefae6283f5d88ade1e241890f192d458.pdf</a></li>
</ul>
</li>
<li>Performance Evaluation of Edge‐Directed Interpolation Methods for Images Abstract
<ul>
<li><a href="https://arxiv.org/abs/1303.6455v1">https://arxiv.org/abs/1303.6455v1</a>
<ul>
<li><a href="https://arxiv.org/pdf/1303.6455v1.pdf">https://arxiv.org/pdf/1303.6455v1.pdf</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </section>
</article>

        </main>
      </div>
    <footer>
  <div class="container">
    <span class="copyright">&copy; 2020 awm-Tech - <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
  </div>
</footer>

  </body>
</html>

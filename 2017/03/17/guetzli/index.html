<!DOCTYPE html>
<html lang="ja-JP">
<head>
<meta charset="utf-8">
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="awmlabs">
<meta name="generator" content="Hugo 0.20-DEV" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type="text/css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="awm-Tech">
<title>Guetzli - Perceptual JPEG encoder - awm-Tech</title>
</head>
<body>

<header>
  <div class="container">
    <a class="path" href="https://blog.awm.jp/">[awm-Tech]</a>
    <span class="caret"># _</span>
  </div>
</header>

<div class="container">


<main role="main" class="article">
  

<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">
    <div style="float:left;">  
<div id="fb-root"></div>
<script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1";
        fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-like" data-href=" https://blog.awm.jp/2017/03/17/guetzli/" data-colorscheme="light" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
<a href="https://b.hatena.ne.jp/entry/blog.awm.jp/2017/03/17/guetzli/" class="hatena-bookmark-button" data-hatena-bookmark-title="Guetzli - Perceptual JPEG encoder" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリー
をはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://blog.awm.jp/2017/03/17/guetzli/" data-lang="ja" data-hashtags="awmtech">ツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
 </div>

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2017-03-17">March 17, 2017</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="https://blog.awm.jp/categories/jpeg">JPEG</a>

    </span>


    <br>
    <span class="key">tags:</span>
    <span class="val">

        <a href="https://blog.awm.jp/tags/jpeg">JPEG</a>

        <a href="https://blog.awm.jp/tags/graphics">Graphics</a>

        <a href="https://blog.awm.jp/tags/guetzli">Guetzli</a>

    </span>

  </div>
  <h1 class="headline" itemprop="headline">Guetzli - Perceptual JPEG encoder</h1>

  <section class="body" itemprop="articleBody">
    <nav id="TableOfContents">
<ul>
<li><a href="#公式サイト">公式サイト</a></li>
<li><a href="#はじめに">はじめに</a></li>
<li><a href="#制限事項">制限事項</a></li>
<li><a href="#インストール">インストール</a></li>
<li><a href="#実験">実験</a></li>
<li><a href="#かかる時間の目安">かかる時間の目安</a></li>
<li><a href="#最後に">最後に</a></li>
</ul>
</nav>
    

<h1 id="公式サイト">公式サイト</h1>

<ul>
<li><a href="https://github.com/google/guetzli">https://github.com/google/guetzli</a></li>
<li>Announcing Guetzli: A New Open Source JPEG Encoder

<ul>
<li><a href="https://research.googleblog.com/2017/03/announcing-guetzli-new-open-source-jpeg.html">https://research.googleblog.com/2017/03/announcing-guetzli-new-open-source-jpeg.html</a></li>
</ul></li>
</ul>

<h1 id="はじめに">はじめに</h1>

<ul>
<li>Guetzli は知覚的(Perceptual)に人間が見ても分からないだろうギリギリまで画像を劣化させるチキンレース技術です。</li>

<li><p>人間が見ても。という部分は画質評価ツールの Butteraugli を使います。論文では MSE, PNSR, SSIM をよく見かけますが、これらは結構雑な評価で、Butteraugli は人間の視覚特性(例えば輝度と色味は別指標、色味も反対色説の色差軸)を考慮した計算をします
<center>
<img src="../opponent-color.jpg" /> <br />
&copy; <a href="http://ieeexplore.ieee.org/ieee_pilot/articles/06/ttg2009061291/article.html">http://ieeexplore.ieee.org/ieee_pilot/articles/06/ttg2009061291/article.html</a>
</center></p></li>

<li><p>JPEG quality を色々弄って画像サイズと画質のトレードオフで決める事はよくありますが、それの全自動版だと考えて良いです。DQT (周波数成分毎の量子化パラメータ) を細かくいじります</p></li>

<li><p>良い結果が出るよう何度も繰り返し JPEG 生成処理をする方式なので、とにかく処理に時間がかかります。libjpeg の代わりという訳にはいかないでしょう。zopfli のようにアクセスが特別多い重要な画像に対してサイズを少しでも減らしたい。という場合に有益です</p></li>
</ul>

<h1 id="制限事項">制限事項</h1>

<p>ソースを読んでいて気づいた制限事項です。</p>

<ul>
<li>YCbCr JPEG のみ対応です。CMYK や CYYK は未対応。

<ul>
<li>参考1) <a href="https://blog.awm.jp/2016/02/06/ycbcr/">https://blog.awm.jp/2016/02/06/ycbcr/</a> YCbCr について</li>
</ul></li>
<li>YUV444, 420 のみ。422,411,440 は駄目。

<ul>
<li>参考2) <a href="https://blog.awm.jp/2016/02/10/yuv/">https://blog.awm.jp/2016/02/10/yuv/</a> YUV の種類</li>
</ul></li>
</ul>

<p>うーん。YUV422 の JPEG は世に溢れてるはずだけど、大丈夫なのでしょうか。420 なんかよりずっと多そうだけど。デジカメで普通の画質設定だと 422 になりそうです。(自分は高画質しか興味ないので、よく分からない)</p>

<p>あと、ICC プロファイルを引き継がないという噂がありますが、自分が試した限りでは引き継ぎます。ソースコードを見ても確かにコピーする処理があります。</p>

<ul>
<li>参考) <a href="https://twitter.com/yoya/status/843085874036334593">https://twitter.com/yoya/status/843085874036334593</a></li>
</ul>

<p>どなたか引き継がない JPEG ファイルをお持ちでしたら頂けないでしょうか。(直してコントリビュータに紛れ込みたい！)</p>

<h1 id="インストール">インストール</h1>

<p>macOS だと brew install guetzli で入りますが、一応 git レポジトリを使う方法のメモです。
libpng(libpng-dev) と gflags (libgflags-dev) のパッケージを入れて make するだけです。macOS Sierra と Linux Ubuntu16 で動作しました。</p>

<pre><code>% git clone git@github.com:google/guetzli.git
% cd guetzli
% make
==== Building guetzli (release) ====
Creating bin/Release
Creating obj/Release
＜略＞
butteraugli.cc
Linking guetzli
ld: warning: option -s is obsolete and being ignored
% ls -l bin/Release/guetzli
-rwxr-xr-x  1 yoya  staff  280856  3 17 17:34 bin/Release/guetzli
% 
</code></pre>

<h1 id="実験">実験</h1>

<pre><code>% ls illust | wc
   1406    1406   26445
% mkdir tmp
% cd illust
% (for i in *.jpg ; do o=&quot;../tmp/$i&quot; ; identify $i ; time guetzli $i $o ; identify $o ; done &gt;&amp; ../log.txt ) &amp;
</code></pre>

<ul>
<li>ログデータ</li>
</ul>

<pre><code>3b689cd9.jpg JPEG 500x375 500x375+0+0 8-bit sRGB 59.4KB 0.000u 0:00.000

real	0m7.194s
user	0m6.976s
sys	0m0.212s
../tmp/3b689cd9.jpg JPEG 500x375 500x375+0+0 8-bit sRGB 56KB 0.000u 0:00.000
</code></pre>

<ul>
<li>ログ集計</li>
</ul>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>foreach (file($argv[1]) as $line) {
    if (preg_match(&quot;/^([^\/]+.jpg) JPEG (\d+)x(\d+) \S+ \S+ \S+ ([0-9\.]+)KB/&quot;,
 $line, $matches)) {
        list($all, $file, $width, $height, $time) = $matches;
        $nPixel = $width * $height;
        $size = (int) sqrt($nPixel);
    } else if (preg_match(&quot;/^user\s+(\d+)m([\d\.]+)s/&quot;, $line, $matches)) {
        list($all, $minutes, $seconds) = $matches;
        $t = 60 * $minutes + $seconds;
        if ($t &gt; 0.01) {
           echo &quot;$size,$t\n&quot;;
        }
    }
}
</pre></div>


<h1 id="かかる時間の目安">かかる時間の目安</h1>

<p>手元にある2Dイラスト画像1360枚で Guetzli を動かして計測したグラフです。</p>

<p><center> <img src="../time-graph-small.png" /> </center></p>

<ul>
<li>横がsqrt(width*height) 。正方形と仮定した場合の一辺の長さ相当</li>
<li>縦が user 時間の秒数</li>
</ul>

<p>一辺2000px で100秒弱〜200秒が目安になりそうです。</p>

<p>ちなみにそこそこ高性能なゲームPCで実験してます。</p>

<h1 id="最後に">最後に</h1>

<p>Guetzli で処理するとデータの劣化はするので、例えば画像を引き伸ばした時や画像にフィルタをかけた時に、違いが目に見える可能性があります。チキンレースで崖の位置が変われば当然落ちますし。画質評価で設定するその崖の位置は、モニタのDPI、視距離、測色標準観察者の種類といった想定する視聴環境のモデル次第です。</p>

  </section>
</article>

</main>


</div>

<footer>
  <div class="container">
    <span class="copyright">&copy; 2017  awm-Tech - <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
  </div>
</footer>

</body>
</html>

